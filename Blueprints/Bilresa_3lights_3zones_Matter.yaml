blueprint:
  name: IKEA Bilresa (Matter) - 3 zones -> 3 lights (configurable, No Action everywhere)
  description: >
    IKEA Bilresa via Matter: 3 zones (1/2, 4/5, 7/8) each controls its own light/group.
    You can set No Action for any input (scroll up/down, button single/double/hold).
    Middle button per zone is (3 / 6 / 9) event entity.
    Responsiveness: mode restart + scroll debounce + anti-stale event filtering.

  domain: automation

  input:
    # Targets
    light_1:
      name: Zone 1 Light/Group
      selector:
        entity:
          domain: [light]
          multiple: false
    light_2:
      name: Zone 2 Light/Group
      selector:
        entity:
          domain: [light]
          multiple: false
    light_3:
      name: Zone 3 Light/Group
      selector:
        entity:
          domain: [light]
          multiple: false

    # Scroll entities (Matter often shows these as "Current switch position (x)")
    scroll_1_up:
      name: Zone 1 Scroll UP entity (1)
      selector:
        entity:
          multiple: false
          filter:
            - domain: sensor
            - domain: number
    scroll_1_down:
      name: Zone 1 Scroll DOWN entity (2)
      selector:
        entity:
          multiple: false
          filter:
            - domain: sensor
            - domain: number

    scroll_2_down:
      name: Zone 2 Scroll DOWN entity (4)
      selector:
        entity:
          multiple: false
          filter:
            - domain: sensor
            - domain: number
    scroll_2_up:
      name: Zone 2 Scroll UP entity (5)
      selector:
        entity:
          multiple: false
          filter:
            - domain: sensor
            - domain: number

    scroll_3_up:
      name: Zone 3 Scroll UP entity (7)
      selector:
        entity:
          multiple: false
          filter:
            - domain: sensor
            - domain: number
    scroll_3_down:
      name: Zone 3 Scroll DOWN entity (8)
      selector:
        entity:
          multiple: false
          filter:
            - domain: sensor
            - domain: number

    # Button events (Matter event entities)
    btn_3:
      name: Zone 1 Middle Button event (3)
      selector:
        entity:
          filter:
            - domain: event
    btn_6:
      name: Zone 2 Middle Button event (6)
      selector:
        entity:
          filter:
            - domain: event
    btn_9:
      name: Zone 3 Middle Button event (9)
      selector:
        entity:
          filter:
            - domain: event

    # Per-zone: scroll actions (No action possible)
    z1_scroll_up_action:
      name: Zone 1 - Scroll UP action
      default: brightness
      selector:
        select:
          options:
            - label: No action
              value: none
            - label: Brightness step up/down
              value: brightness
            - label: Kelvin step up/down
              value: kelvin
            - label: RGB Hue step up/down
              value: rgb
            - label: Preset (Bright+Cool / Dim+Warm)
              value: preset

    z1_scroll_down_action:
      name: Zone 1 - Scroll DOWN action
      default: brightness
      selector:
        select:
          options:
            - label: No action
              value: none
            - label: Brightness step up/down
              value: brightness
            - label: Kelvin step up/down
              value: kelvin
            - label: RGB Hue step up/down
              value: rgb
            - label: Preset (Bright+Cool / Dim+Warm)
              value: preset

    z2_scroll_up_action:
      name: Zone 2 - Scroll UP action
      default: none
      selector:
        select:
          options:
            - label: No action
              value: none
            - label: Brightness step up/down
              value: brightness
            - label: Kelvin step up/down
              value: kelvin
            - label: RGB Hue step up/down
              value: rgb
            - label: Preset (Bright+Cool / Dim+Warm)
              value: preset

    z2_scroll_down_action:
      name: Zone 2 - Scroll DOWN action
      default: none
      selector:
        select:
          options:
            - label: No action
              value: none
            - label: Brightness step up/down
              value: brightness
            - label: Kelvin step up/down
              value: kelvin
            - label: RGB Hue step up/down
              value: rgb
            - label: Preset (Bright+Cool / Dim+Warm)
              value: preset

    z3_scroll_up_action:
      name: Zone 3 - Scroll UP action
      default: preset
      selector:
        select:
          options:
            - label: No action
              value: none
            - label: Brightness step up/down
              value: brightness
            - label: Kelvin step up/down
              value: kelvin
            - label: RGB Hue step up/down
              value: rgb
            - label: Preset (Bright+Cool / Dim+Warm)
              value: preset

    z3_scroll_down_action:
      name: Zone 3 - Scroll DOWN action
      default: preset
      selector:
        select:
          options:
            - label: No action
              value: none
            - label: Brightness step up/down
              value: brightness
            - label: Kelvin step up/down
              value: kelvin
            - label: RGB Hue step up/down
              value: rgb
            - label: Preset (Bright+Cool / Dim+Warm)
              value: preset

    # Per-zone: middle button actions (single / double / hold) with No action
    z1_single:
      name: Zone 1 - Middle SINGLE press (3)
      default: toggle
      selector:
        select:
          options:
            - label: No action
              value: none
            - label: Toggle
              value: toggle
            - label: Turn ON
              value: on
            - label: Turn OFF
              value: off
    z1_double:
      name: Zone 1 - Middle DOUBLE press (3)
      default: none
      selector:
        select:
          options:
            - label: No action
              value: none
            - label: Set Bright preset
              value: set_bright
            - label: Set Dim preset
              value: set_dim
            - label: Set Cool preset
              value: set_cool
            - label: Set Warm preset
              value: set_warm
            - label: Enable Color (saturation on)
              value: set_color_on
            - label: Set Red
              value: set_red
    z1_hold:
      name: Zone 1 - Middle HOLD (3)
      default: kelvin_cycle
      selector:
        select:
          options:
            - label: No action
              value: none
            - label: Kelvin cycle (Warm->Neutral->Cool)
              value: kelvin_cycle
            - label: Set Bright preset
              value: set_bright
            - label: Set Dim preset
              value: set_dim
            - label: Set Cool preset
              value: set_cool
            - label: Set Warm preset
              value: set_warm
            - label: Enable Color (saturation on)
              value: set_color_on
            - label: Set Red
              value: set_red

    z2_single:
      name: Zone 2 - Middle SINGLE press (6)
      default: toggle
      selector:
        select:
          options:
            - label: No action
              value: none
            - label: Toggle
              value: toggle
            - label: Turn ON
              value: on
            - label: Turn OFF
              value: off
    z2_double:
      name: Zone 2 - Middle DOUBLE press (6)
      default: none
      selector:
        select:
          options:
            - label: No action
              value: none
            - label: Set Bright preset
              value: set_bright
            - label: Set Dim preset
              value: set_dim
            - label: Set Cool preset
              value: set_cool
            - label: Set Warm preset
              value: set_warm
            - label: Enable Color (saturation on)
              value: set_color_on
            - label: Set Red
              value: set_red
    z2_hold:
      name: Zone 2 - Middle HOLD (6)
      default: none
      selector:
        select:
          options:
            - label: No action
              value: none
            - label: Kelvin cycle (Warm->Neutral->Cool)
              value: kelvin_cycle
            - label: Set Bright preset
              value: set_bright
            - label: Set Dim preset
              value: set_dim
            - label: Set Cool preset
              value: set_cool
            - label: Set Warm preset
              value: set_warm
            - label: Enable Color (saturation on)
              value: set_color_on
            - label: Set Red
              value: set_red

    z3_single:
      name: Zone 3 - Middle SINGLE press (9)
      default: toggle
      selector:
        select:
          options:
            - label: No action
              value: none
            - label: Toggle
              value: toggle
            - label: Turn ON
              value: on
            - label: Turn OFF
              value: off
    z3_double:
      name: Zone 3 - Middle DOUBLE press (9)
      default: none
      selector:
        select:
          options:
            - label: No action
              value: none
            - label: Set Bright preset
              value: set_bright
            - label: Set Dim preset
              value: set_dim
            - label: Set Cool preset
              value: set_cool
            - label: Set Warm preset
              value: set_warm
            - label: Enable Color (saturation on)
              value: set_color_on
            - label: Set Red
              value: set_red
    z3_hold:
      name: Zone 3 - Middle HOLD (9)
      default: kelvin_cycle
      selector:
        select:
          options:
            - label: No action
              value: none
            - label: Kelvin cycle (Warm->Neutral->Cool)
              value: kelvin_cycle
            - label: Set Bright preset
              value: set_bright
            - label: Set Dim preset
              value: set_dim
            - label: Set Cool preset
              value: set_cool
            - label: Set Warm preset
              value: set_warm
            - label: Enable Color (saturation on)
              value: set_color_on
            - label: Set Red
              value: set_red

    # Tuning / responsiveness
    debounce_ms:
      name: Debounce for scroll (ms)
      default: 120
      selector:
        number:
          min: 0
          max: 400
          step: 10
          unit_of_measurement: ms
          mode: slider

    stale_event_window_s:
      name: Ignore stale events older than (seconds)
      default: 5
      selector:
        number:
          min: 1
          max: 30
          step: 1
          unit_of_measurement: s
          mode: slider

    transition_s:
      name: Transition time (seconds)
      default: 0
      selector:
        number:
          min: 0
          max: 5
          step: 0.5
          unit_of_measurement: s
          mode: slider

    # Steps / presets
    step_pct:
      name: Brightness step (%)
      default: 10
      selector:
        number:
          min: 1
          max: 50
          step: 1
          unit_of_measurement: "%"
          mode: slider

    step_kelvin:
      name: Kelvin step (K)
      default: 400
      selector:
        number:
          min: 100
          max: 1200
          step: 50
          unit_of_measurement: K
          mode: slider

    step_hue:
      name: Hue step (degrees)
      default: 15
      selector:
        number:
          min: 5
          max: 90
          step: 1
          unit_of_measurement: "Â°"
          mode: slider

    val_bright:
      name: Preset Bright (%)
      default: 80
      selector:
        number:
          min: 1
          max: 100
          step: 1
          unit_of_measurement: "%"
          mode: slider

    val_dim:
      name: Preset Dim (%)
      default: 20
      selector:
        number:
          min: 1
          max: 100
          step: 1
          unit_of_measurement: "%"
          mode: slider

    val_warm:
      name: Warm Kelvin (cycle/preset)
      default: 2200
      selector:
        number:
          min: 2000
          max: 6500
          step: 50
          unit_of_measurement: K
          mode: slider

    val_neutral:
      name: Neutral Kelvin (cycle)
      default: 3500
      selector:
        number:
          min: 2000
          max: 6500
          step: 50
          unit_of_measurement: K
          mode: slider

    val_cool:
      name: Cool Kelvin (cycle/preset)
      default: 4000
      selector:
        number:
          min: 2000
          max: 6500
          step: 50
          unit_of_measurement: K
          mode: slider

mode: restart
max_exceeded: silent

variables:
  l1: !input light_1
  l2: !input light_2
  l3: !input light_3

  s1u: !input scroll_1_up
  s1d: !input scroll_1_down
  s2u: !input scroll_2_up
  s2d: !input scroll_2_down
  s3u: !input scroll_3_up
  s3d: !input scroll_3_down

  b3: !input btn_3
  b6: !input btn_6
  b9: !input btn_9

  z1_su: !input z1_scroll_up_action
  z1_sd: !input z1_scroll_down_action
  z2_su: !input z2_scroll_up_action
  z2_sd: !input z2_scroll_down_action
  z3_su: !input z3_scroll_up_action
  z3_sd: !input z3_scroll_down_action

  z1_single: !input z1_single
  z1_double: !input z1_double
  z1_hold: !input z1_hold

  z2_single: !input z2_single
  z2_double: !input z2_double
  z2_hold: !input z2_hold

  z3_single: !input z3_single
  z3_double: !input z3_double
  z3_hold: !input z3_hold

  debounce_ms: !input debounce_ms
  stale_s: !input stale_event_window_s
  trans: !input transition_s

  step_pct: !input step_pct
  step_kelvin: !input step_kelvin
  step_hue: !input step_hue

  v_bright: !input val_bright
  v_dim: !input val_dim
  v_warm: !input val_warm
  v_neutral: !input val_neutral
  v_cool: !input val_cool

trigger:
  # Scroll
  - platform: state
    entity_id: !input scroll_1_up
    id: z1_up
  - platform: state
    entity_id: !input scroll_1_down
    id: z1_down

  - platform: state
    entity_id: !input scroll_2_up
    id: z2_up
  - platform: state
    entity_id: !input scroll_2_down
    id: z2_down

  - platform: state
    entity_id: !input scroll_3_up
    id: z3_up
  - platform: state
    entity_id: !input scroll_3_down
    id: z3_down

  # Middle button events
  - platform: state
    entity_id:
      - !input btn_3
      - !input btn_6
      - !input btn_9
    id: mid_event

action:
  - choose:
      # =====================
      # SCROLL
      # =====================
      - conditions:
          - condition: template
            value_template: "{{ trigger.id in ['z1_up','z1_down','z2_up','z2_down','z3_up','z3_down'] }}"
        sequence:
          - variables:
              direction: "{{ 1 if trigger.id.endswith('_up') else -1 }}"
              tl: >
                {% if trigger.id.startswith('z1_') %} {{ l1 }}
                {% elif trigger.id.startswith('z2_') %} {{ l2 }}
                {% else %} {{ l3 }} {% endif %}
              mode: >
                {% if trigger.id == 'z1_up' %} {{ z1_su }}
                {% elif trigger.id == 'z1_down' %} {{ z1_sd }}
                {% elif trigger.id == 'z2_up' %} {{ z2_su }}
                {% elif trigger.id == 'z2_down' %} {{ z2_sd }}
                {% elif trigger.id == 'z3_up' %} {{ z3_su }}
                {% else %} {{ z3_sd }} {% endif %}

          # No action = do nothing
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ mode == 'none' }}"
                sequence: []
              - conditions:
                  - condition: template
                    value_template: "{{ mode == 'brightness' }}"
                sequence:
                  - service: light.turn_on
                    target: {entity_id: "{{ tl }}"}
                    data:
                      brightness_step_pct: "{{ step_pct * direction }}"
                      transition: "{{ trans }}"
              - conditions:
                  - condition: template
                    value_template: "{{ mode == 'kelvin' }}"
                sequence:
                  - service: light.turn_on
                    target: {entity_id: "{{ tl }}"}
                    data:
                      color_temp_kelvin: >
                        {% set current = state_attr(tl, 'color_temp_kelvin') | default(3000) | int %}
                        {% if direction == 1 %}
                          {{ [current + (step_kelvin | int), 6500] | min }}
                        {% else %}
                          {{ [current - (step_kelvin | int), 2000] | max }}
                        {% endif %}
                      transition: "{{ trans }}"
              - conditions:
                  - condition: template
                    value_template: "{{ mode == 'rgb' }}"
                sequence:
                  - service: light.turn_on
                    target: {entity_id: "{{ tl }}"}
                    data:
                      hs_color: >
                        {% set current = state_attr(tl, 'hs_color') %}
                        {% set h = (current[0] if current else 0) | float %}
                        {% set s = (current[1] if current else 100) | float %}
                        {{ [ (h + (step_hue * direction)) % 360, s ] }}
                      transition: "{{ trans }}"
              - conditions:
                  - condition: template
                    value_template: "{{ mode == 'preset' }}"
                sequence:
                  - service: light.turn_on
                    target: {entity_id: "{{ tl }}"}
                    data:
                      brightness_pct: "{{ v_bright if direction == 1 else v_dim }}"
                      color_temp_kelvin: "{{ v_cool if direction == 1 else v_warm }}"
                      transition: "{{ [trans, 0.5] | max }}"

          - delay:
              milliseconds: "{{ debounce_ms | int }}"

      # =====================
      # MIDDLE BUTTON EVENTS (3/6/9)
      # =====================
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'mid_event' }}"
        sequence:
          # Must have event_type
          - condition: template
            value_template: >
              {{ trigger.to_state is not none
                 and trigger.to_state.attributes.event_type is defined
                 and trigger.to_state.attributes.event_type != none }}

          # Anti-stale filter (ignore old reconnect events)
          - condition: template
            value_template: >
              {% set w = stale_s | int %}
              {% set ok_changed = (now() - trigger.to_state.last_changed).total_seconds() < w %}
              {% set dt = (trigger.to_state.state | as_datetime) %}
              {% set ok_state = (dt is not none) and ((now() - (dt | as_local)).total_seconds() < w) %}
              {{ ok_changed or ok_state }}

          - variables:
              et: "{{ trigger.to_state.attributes.event_type }}"
              tl: >
                {% if trigger.entity_id == b3 %} {{ l1 }}
                {% elif trigger.entity_id == b6 %} {{ l2 }}
                {% else %} {{ l3 }} {% endif %}
              act_single: >
                {% if trigger.entity_id == b3 %} {{ z1_single }}
                {% elif trigger.entity_id == b6 %} {{ z2_single }}
                {% else %} {{ z3_single }} {% endif %}
              act_double: >
                {% if trigger.entity_id == b3 %} {{ z1_double }}
                {% elif trigger.entity_id == b6 %} {{ z2_double }}
                {% else %} {{ z3_double }} {% endif %}
              act_hold: >
                {% if trigger.entity_id == b3 %} {{ z1_hold }}
                {% elif trigger.entity_id == b6 %} {{ z2_hold }}
                {% else %} {{ z3_hold }} {% endif %}

          - choose:
              # SINGLE press (multi_press_1 or short_release)
              - conditions:
                  - condition: template
                    value_template: "{{ ('multi_press_1' in et) or ('short_release' in et) }}"
                sequence:
                  - choose:
                      - conditions: "{{ act_single == 'none' }}"
                        sequence: []
                      - conditions: "{{ act_single == 'toggle' }}"
                        sequence:
                          - service: light.toggle
                            target: {entity_id: "{{ tl }}"}
                            data:
                              transition: "{{ [trans, 0.5] | max }}"
                      - conditions: "{{ act_single == 'on' }}"
                        sequence:
                          - service: light.turn_on
                            target: {entity_id: "{{ tl }}"}
                            data:
                              transition: "{{ [trans, 0.5] | max }}"
                      - conditions: "{{ act_single == 'off' }}"
                        sequence:
                          - service: light.turn_off
                            target: {entity_id: "{{ tl }}"}
                            data:
                              transition: "{{ [trans, 0.5] | max }}"

              # DOUBLE press (multi_press_2)
              - conditions:
                  - condition: template
                    value_template: "{{ 'multi_press_2' in et }}"
                sequence:
                  - choose:
                      - conditions: "{{ act_double == 'none' }}"
                        sequence: []
                      - conditions: "{{ act_double == 'set_bright' }}"
                        sequence:
                          - service: light.turn_on
                            target: {entity_id: "{{ tl }}"}
                            data:
                              brightness_pct: "{{ v_bright }}"
                              transition: "{{ [trans, 0.5] | max }}"
                      - conditions: "{{ act_double == 'set_dim' }}"
                        sequence:
                          - service: light.turn_on
                            target: {entity_id: "{{ tl }}"}
                            data:
                              brightness_pct: "{{ v_dim }}"
                              transition: "{{ [trans, 0.5] | max }}"
                      - conditions: "{{ act_double == 'set_warm' }}"
                        sequence:
                          - service: light.turn_on
                            target: {entity_id: "{{ tl }}"}
                            data:
                              color_temp_kelvin: "{{ v_warm }}"
                              transition: "{{ [trans, 0.5] | max }}"
                      - conditions: "{{ act_double == 'set_cool' }}"
                        sequence:
                          - service: light.turn_on
                            target: {entity_id: "{{ tl }}"}
                            data:
                              color_temp_kelvin: "{{ v_cool }}"
                              transition: "{{ [trans, 0.5] | max }}"
                      - conditions: "{{ act_double == 'set_color_on' }}"
                        sequence:
                          - service: light.turn_on
                            target: {entity_id: "{{ tl }}"}
                            data:
                              hs_color: [0, 100]
                              brightness_pct: "{{ v_bright }}"
                              transition: "{{ [trans, 0.5] | max }}"
                      - conditions: "{{ act_double == 'set_red' }}"
                        sequence:
                          - service: light.turn_on
                            target: {entity_id: "{{ tl }}"}
                            data:
                              hs_color: [0, 100]
                              brightness_pct: 80
                              transition: "{{ [trans, 0.5] | max }}"

              # HOLD (long_press)
              - conditions:
                  - condition: template
                    value_template: "{{ 'long_press' in et }}"
                sequence:
                  - choose:
                      - conditions: "{{ act_hold == 'none' }}"
                        sequence: []
                      - conditions: "{{ act_hold == 'kelvin_cycle' }}"
                        sequence:
                          - service: light.turn_on
                            target: {entity_id: "{{ tl }}"}
                            data:
                              color_temp_kelvin: >
                                {% set current = state_attr(tl, 'color_temp_kelvin') | int(0) %}
                                {% set mid_wn = ((v_warm + v_neutral) / 2) %}
                                {% set mid_nc = ((v_neutral + v_cool) / 2) %}
                                {% if current == 0 or current <= mid_wn %}
                                  {{ v_neutral }}
                                {% elif current <= mid_nc %}
                                  {{ v_cool }}
                                {% else %}
                                  {{ v_warm }}
                                {% endif %}
                              transition: "{{ [trans, 0.5] | max }}"
                      - conditions: "{{ act_hold == 'set_bright' }}"
                        sequence:
                          - service: light.turn_on
                            target: {entity_id: "{{ tl }}"}
                            data:
                              brightness_pct: "{{ v_bright }}"
                              transition: "{{ [trans, 0.5] | max }}"
                      - conditions: "{{ act_hold == 'set_dim' }}"
                        sequence:
                          - service: light.turn_on
                            target: {entity_id: "{{ tl }}"}
                            data:
                              brightness_pct: "{{ v_dim }}"
                              transition: "{{ [trans, 0.5] | max }}"
                      - conditions: "{{ act_hold == 'set_warm' }}"
                        sequence:
                          - service: light.turn_on
                            target: {entity_id: "{{ tl }}"}
                            data:
                              color_temp_kelvin: "{{ v_warm }}"
                              transition: "{{ [trans, 0.5] | max }}"
                      - conditions: "{{ act_hold == 'set_cool' }}"
                        sequence:
                          - service: light.turn_on
                            target: {entity_id: "{{ tl }}"}
                            data:
                              color_temp_kelvin: "{{ v_cool }}"
                              transition: "{{ [trans, 0.5] | max }}"
                      - conditions: "{{ act_hold == 'set_color_on' }}"
                        sequence:
                          - service: light.turn_on
                            target: {entity_id: "{{ tl }}"}
                            data:
                              hs_color: [0, 100]
                              brightness_pct: "{{ v_bright }}"
                              transition: "{{ [trans, 0.5] | max }}"
                      - conditions: "{{ act_hold == 'set_red' }}"
                        sequence:
                          - service: light.turn_on
                            target: {entity_id: "{{ tl }}"}
                            data:
                              hs_color: [0, 100]
                              brightness_pct: 80
                              transition: "{{ [trans, 0.5] | max }}"
